<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - VL ONLINE SHOP</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f5f2;
      color: #333;
      margin: 0;
      padding-bottom: 100px;
    }
    header {
      background-color: #1a1a1a;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header span {
      color: #e0b973;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    select, button {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 10px;
    }
    button {
      background-color: #1a1a1a;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background-color: gray;
    }
    .summary {
      font-size: 16px;
    }
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <header>
    <div>üõçÔ∏è <span>VL ONLINE SHOP</span></div>
  </header>

  <div class="container">
    <div class="section">
      <label>Alamat Pengiriman</label>
      <input type="text" id="alamat" placeholder="Masukkan alamat Anda">
      <button onclick="saveAddress()">Simpan Alamat</button>
      <select id="alamatTersimpan" onchange="pilihAlamat(this.value)"></select>
    </div>

    <div class="section">
      <label>Metode Pembayaran</label>
      <select id="metodePembayaran" onchange="checkCODLimit()">
        <option value="bca">Transfer BCA</option>
        <option value="qris">QRIS</option>
        <option value="cod">COD</option>
      </select>
    </div>

    <div class="section summary">
      <p>Total Belanja: <span id="totalBelanja">Rp0</span></p>
      <p>Ongkir: <span id="ongkir">Rp0</span></p>
      <p>Total Bayar: <span id="totalBayar">Rp0</span></p>
    </div>

    <button onclick="selesaikanPembayaran()" id="btnBayar">Selesaikan Pembayaran</button>
  </div>

  <div class="popup" id="popup">
    <div class="popup-content" id="popupContent"></div>
  </div>

  <script>
    const pusat = { lat: -1.6409491, lon: 105.771176 };
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let totalBelanja = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    let adminFee = 0;

    document.getElementById('totalBelanja').textContent = formatRupiah(totalBelanja);

    function formatRupiah(num) {
      return 'Rp' + num.toLocaleString('id-ID');
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function getOngkir(distance) {
      if (distance <= 1000) return 5000;
      return 5000 + Math.floor((distance - 1000) / 1000) * 2000;
    }

    function saveAddress() {
      const alamat = document.getElementById('alamat').value;
      if (alamat) {
        let data = JSON.parse(localStorage.getItem('alamatTersimpan')) || [];
        data.push(alamat);
        localStorage.setItem('alamatTersimpan', JSON.stringify(data));
        renderAlamat();
      }
    }

    function renderAlamat() {
      const select = document.getElementById('alamatTersimpan');
      select.innerHTML = '';
      const data = JSON.parse(localStorage.getItem('alamatTersimpan')) || [];
      data.forEach(alamat => {
        const opt = document.createElement('option');
        opt.value = alamat;
        opt.textContent = alamat;
        select.appendChild(opt);
      });
    }

    function pilihAlamat(value) {
      document.getElementById('alamat').value = value;
    }

    function checkCODLimit() {
      const metode = document.getElementById('metodePembayaran').value;
      const btn = document.getElementById('btnBayar');
      if (metode === 'cod' && totalBelanja > 100000) {
        btn.disabled = true;
      } else {
        btn.disabled = false;
      }
    }

    function selesaikanPembayaran() {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;
        const distance = calculateDistance(pusat.lat, pusat.lon, userLat, userLon);
        const ongkir = getOngkir(distance);
        const metode = document.getElementById('metodePembayaran').value;
        adminFee = Math.floor(Math.random() * 501);
        const total = totalBelanja + ongkir + adminFee;

        document.getElementById('ongkir').textContent = formatRupiah(ongkir);
        document.getElementById('totalBayar').textContent = formatRupiah(total);

        let detail = `Metode: ${metode.toUpperCase()}\nTotal: ${formatRupiah(total)}\nAdmin Fee: ${formatRupiah(adminFee)}\n`;
        if (metode === 'bca') {
          detail += 'Transfer ke: 1234567890 (BCA a.n VL SHOP)\n';
        } else if (metode === 'qris') {
          detail += 'Scan kode QR berikut untuk bayar.\n';
        }

        detail += '\nBarang:\n' + cart.map(item => `- ${item.name} x${item.quantity}`).join('\n');

        document.getElementById('popupContent').innerHTML = `
          <h3>Rincian Pembayaran</h3>
          <pre>${detail}</pre>
          <button onclick="kirimWhatsApp('${encodeURIComponent(detail)}')">Kirim ke WhatsApp</button>
        `;

        document.getElementById('popup').style.display = 'flex';
      });
    }

    function kirimWhatsApp(detail) {
      const url = `https://wa.me/6285709458101?text=${detail}`;
      window.open(url, '_blank');
    }

    renderAlamat();
    checkCODLimit();
  </script>
</body>
</html>
