<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VL ONLINE SHOP - Pembayaran</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f5f2;
      color: #333;
    }
    header {
      position: sticky;
      top: 0;
      background-color: #1a1a1a;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      z-index: 1000;
    }
    header span {
      color: #e0b973;
      margin-left: 10px;
    }
    .container {
      padding: 40px;
    }
    #summary {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #map {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      margin-top: 20px;
    }
    h2 {
      color: #1a1a1a;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 10px;
    }
    #manualLocation {
      margin-top: 20px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #1a1a1a;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div>üõçÔ∏è <span>VL ONLINE SHOP</span></div>
  </header>
  <div class="container">
    <div id="summary">
      <h2>Ringkasan Pembelian</h2>
      <ul id="orderList"></ul>
      <p><strong>Ongkir:</strong> Rp<span id="shipping">0</span></p>
      <p><strong>Total:</strong> Rp<span id="total">0</span></p>
      <p><strong>Jarak ke toko:</strong> <span id="distance">0</span> km</p>
    </div>

    <div id="manualLocation">
      <h3>Atau tentukan lokasi secara manual dengan klik peta:</h3>
      <button onclick="enableManualMarker()">Aktifkan Penanda Manual</button>
    </div>

    <div id="map"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const cartData = JSON.parse(decodeURIComponent(params.get('cart')));

    const orderList = document.getElementById('orderList');
    const shippingEl = document.getElementById('shipping');
    const totalEl = document.getElementById('total');
    const distanceEl = document.getElementById('distance');

    const storeLat = -1.6409491;
    const storeLng = 105.771176;
    let totalHarga = 0;
    let map;
    let manualMarker;
    let allowManual = false;

    function calculateDistance(userLat, userLng) {
      const R = 6371e3;
      const œÜ1 = userLat * Math.PI / 180;
      const œÜ2 = storeLat * Math.PI / 180;
      const ŒîœÜ = (storeLat - userLat) * Math.PI / 180;
      const ŒîŒª = (storeLng - userLng) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    function tampilkanPeta(userLat, userLng) {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: { lat: userLat, lng: userLng },
      });

      new google.maps.Marker({ position: { lat: storeLat, lng: storeLng }, map, label: "Toko" });
      new google.maps.Marker({ position: { lat: userLat, lng: userLng }, map, label: "Anda" });

      map.addListener("click", function(e) {
        if (!allowManual) return;
        if (manualMarker) manualMarker.setMap(null);
        manualMarker = new google.maps.Marker({ position: e.latLng, map, label: "Anda" });
        hitungOngkir(e.latLng.lat(), e.latLng.lng());
      });
    }

    function hitungOngkir(userLat, userLng) {
      const distance = calculateDistance(userLat, userLng);
      distanceEl.textContent = (distance / 1000).toFixed(2);

      let shipping = 5000;
      if (distance > 1000) {
        const extraKm = Math.ceil((distance - 1000) / 1000);
        shipping += extraKm * 2000;
      }

      shippingEl.textContent = shipping.toLocaleString('id-ID');
      totalEl.textContent = (totalHarga + shipping).toLocaleString('id-ID');
    }

    function enableManualMarker() {
      allowManual = true;
      alert("Klik pada peta untuk memilih lokasi Anda.");
    }

    function renderCart(cart) {
      totalHarga = 0;
      cart.forEach(item => {
        const subtotal = item.price * item.quantity;
        totalHarga += subtotal;
        const li = document.createElement('li');
        li.textContent = `${item.name} x ${item.quantity} = Rp${subtotal.toLocaleString('id-ID')}`;
        orderList.appendChild(li);
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          hitungOngkir(position.coords.latitude, position.coords.longitude);
          tampilkanPeta(position.coords.latitude, position.coords.longitude);
        }, () => {
          alert("Gagal mendapatkan lokasi Anda. Silakan pilih lokasi di peta.");
          tampilkanPeta(storeLat, storeLng);
        });
      } else {
        alert("Geolokasi tidak didukung browser. Silakan pilih lokasi di peta.");
        tampilkanPeta(storeLat, storeLng);
      }
    }

    renderCart(cartData);
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?callback=Function.prototype"></script>
</body>
</html>
